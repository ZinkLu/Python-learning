# 08.单例

> 单例设计模式的意义？在哪里？

## 目标

- 单例设计模式
- `__new__`方法
- Python中的单例

<br><br><br>


## 1、单例设计模式

- 设计模式
	- **设计模式**是前人工作的**总结和提炼**，通常，被人们广泛流传的设计模式都是针对 **某一特定问题** 的成熟方案
	- 使用 **设计模式** 是为了可重用代码、让代码更容易被他人理解、保证代码的可靠性

- 单例设计模式
	- **目的** —— 让**类**创建的对象，在系统中**只有 唯一的一个实例**
	- 每一行执行`类名()`返回的对象，**内存地址是相同的**

> MVC设计模式

<br><br><br>

## 2、`__new__`方法

> 只能创建一个实例？

- 使用 **类名()** 创建对象时，`Python`的解释器 **首先** 会调用`__new__`方法为对象 **分配空间** 

- `__new__`是一个由`object`基类提供的 **内置的静态方法** 主要的作用有两个：
	- 1  在内存中为对象 **分配空间**
	- 2  **返回** 对象的引用
- `Python`的解释器获得对象的 **引用** 后，将引用作为 **第一个参数** ，传递给`__new__`方法

> 重写`__new__`方法的代码非常固定

- 重写`__new__`方法一定要`return super().__new__(cls)` / `return object.__new__(cls)`  **推荐后一种方法**

- 否则Python解释器得不到分配了空间的  **对象引用，就不会调用对象的初始化方法** 

- 注意：`__new__`是一个静态方法，在调用时需要 **主动传递** `cls`参数

<br>

> ==`__new__(cls, *args, **kwargs)`方法的后两个参数的由来，不定长参数==
>
> 因为init方法的参数也需要和new方法共享，但是new方法用不到，所以用不定长参数接受了所有参数
>
> 为什么..这中间发生了什么？


<br>
<br>
<br>

## 3、Python中的单例

> 通过new方法手动设置

> 用一个类属性记录第一个创建的实例，以后每次再新建一个实例的时候，就会用new方法返回第一个实例，因此做到无法创建其他实例

- 单例 -- 让 类 创建的对象，在系统中只有唯一的实例
	1. 定义一个**类属性**，初始值是`None`，用于记录 **单例对象的引用**
	2. 重写`__new__`方法
	3. 如果 **类属性** `is none` ，调用父类方法分配空间，并在类属性中记录结果
	4. 返回 **类属性** 中记录的 **对象引用**

#### 只执行一次初始化工作

- 如果使用了单例设计模式，在创建对象时永远返回的是第一个创建的对象，这时，其他的实例初始化方法显得没有意义，一次可以做一个只执行一次初始化工作的功能。

- 方法
	1. 定义一个 **类属性** 来记录是否第一次调用初始化方法
	2. 在init方法中判断
	3. 如果该标记显示第一次创建实例，则编写初始化方法执行代码
	4. 如果不是第一次，直接return

> 该课程演示代码如下

```python
# 我还是没搞清楚 单例设计模式的意义在哪里

class MusicPlayer(object):

    # 记录一个被创建的对象的引用，这个变量永远指向第一个实例
    instance = None

    # 记录是否进行过初始化方法
    init_flag = False

    # 重写new方法
    def __new__(cls, *args, **kwargs):

        # 1. 判断类属性是否是空对象
        if cls.instance is None:

            # 2. 调用父类方法，为第一个对象分配空间

            cls.instance = super().__new__(cls)

            return cls.instance

            # 3. 返回类属性保存的对象引用

        return cls.instance

    def __init__(self, name=''):

        # 1. 判断是都执行过初始化动作，就直接不初始化了，因为调用类直接返回了第一个实例
        if MusicPlayer.init_flag:
            return

        # 2. 如果没有执行过，执行初始化
        print("初始化播放器")
        self.name = name

        # 3. 将标记改掉
        MusicPlayer.init_flag = True


# 创建多个对象，保存在相同的内存地址里
player1 = MusicPlayer("QQ")
print(player1)

player2 = MusicPlayer()  # 因为是缺省参数，则可以不传参
print(player2)

print(MusicPlayer.init_flag)
print(player1.init_flag)
print(player2.init_flag)
```













